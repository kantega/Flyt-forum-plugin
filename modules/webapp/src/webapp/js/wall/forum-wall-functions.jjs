//<%@ taglib uri="http://www.kantega.no/aksess/tags/aksess" prefix="aksess" %>
//<%@ taglib prefix="kantega" uri="http://www.kantega.no/aksess/tags/commons" %>

// jQuery plugins

/*!
 * jQuery Form Plugin
 * version: 2.84 (12-AUG-2011)
 * @requires jQuery v1.3.2 or later
 *
 * Examples and documentation at: http://malsup.com/jquery/form/
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */

(function(e){function t(){var e="[jquery.form] "+Array.prototype.join.call(arguments,"");if(window.console&&window.console.log){window.console.log(e)}else if(window.opera&&window.opera.postError){window.opera.postError(e)}}e.fn.ajaxSubmit=function(n){function b(i){function S(e){var t=e.contentWindow?e.contentWindow.document:e.contentDocument?e.contentDocument:e.document;return t}function x(){function u(){try{var e=S(p).readyState;t("state = "+e);if(e.toLowerCase()=="uninitialized")setTimeout(u,50)}catch(n){t("Server abort: ",n," (",n.name,")");L(E);y&&clearTimeout(y);y=undefined}}var n=o.attr("target"),i=o.attr("action");s.setAttribute("target",c);if(!r){s.setAttribute("method","POST")}if(i!=f.url){s.setAttribute("action",f.url)}if(!f.skipEncodingOverride&&(!r||/post/i.test(r))){o.attr({encoding:"multipart/form-data",enctype:"multipart/form-data"})}if(f.timeout){y=setTimeout(function(){g=true;L(w)},f.timeout)}var a=[];try{if(f.extraData){for(var l in f.extraData){a.push(e('<input type="hidden" name="'+l+'" />').attr("value",f.extraData[l]).appendTo(s)[0])}}if(!f.iframeTarget){h.appendTo("body");p.attachEvent?p.attachEvent("onload",L):p.addEventListener("load",L,false)}setTimeout(u,15);s.submit()}finally{s.setAttribute("action",i);if(n){s.setAttribute("target",n)}else{o.removeAttr("target")}e(a).remove()}}function L(n){if(d.aborted||k){return}try{N=S(p)}catch(r){t("cannot access response document: ",r);n=E}if(n===w&&d){d.abort("timeout");return}else if(n==E&&d){d.abort("server abort");return}if(!N||N.location.href==f.iframeSrc){if(!g)return}p.detachEvent?p.detachEvent("onload",L):p.removeEventListener("load",L,false);var i="success",s;try{if(g){throw"timeout"}var o=f.dataType=="xml"||N.XMLDocument||e.isXMLDoc(N);t("isXml="+o);if(!o&&window.opera&&(N.body==null||N.body.innerHTML=="")){if(--C){t("requeing onLoad callback, DOM not available");setTimeout(L,250);return}}var u=N.body?N.body:N.documentElement;d.responseText=u?u.innerHTML:null;d.responseXML=N.XMLDocument?N.XMLDocument:N;if(o)f.dataType="xml";d.getResponseHeader=function(e){var t={"content-type":f.dataType};return t[e]};if(u){d.status=Number(u.getAttribute("status"))||d.status;d.statusText=u.getAttribute("statusText")||d.statusText}var a=f.dataType||"";var c=/(json|script|text)/.test(a.toLowerCase());if(c||f.textarea){var v=N.getElementsByTagName("textarea")[0];if(v){d.responseText=v.value;d.status=Number(v.getAttribute("status"))||d.status;d.statusText=v.getAttribute("statusText")||d.statusText}else if(c){var m=N.getElementsByTagName("pre")[0];var b=N.getElementsByTagName("body")[0];if(m){d.responseText=m.textContent?m.textContent:m.innerHTML}else if(b){d.responseText=b.innerHTML}}}else if(f.dataType=="xml"&&!d.responseXML&&d.responseText!=null){d.responseXML=A(d.responseText)}try{T=M(d,f.dataType,f)}catch(n){i="parsererror";d.error=s=n||i}}catch(n){t("error caught: ",n);i="error";d.error=s=n||i}if(d.aborted){t("upload aborted");i=null}if(d.status){i=d.status>=200&&d.status<300||d.status===304?"success":"error"}if(i==="success"){f.success&&f.success.call(f.context,T,"success",d);l&&e.event.trigger("ajaxSuccess",[d,f])}else if(i){if(s==undefined)s=d.statusText;f.error&&f.error.call(f.context,d,i,s);l&&e.event.trigger("ajaxError",[d,f,s])}l&&e.event.trigger("ajaxComplete",[d,f]);if(l&&!--e.active){e.event.trigger("ajaxStop")}f.complete&&f.complete.call(f.context,d,i);k=true;if(f.timeout)clearTimeout(y);setTimeout(function(){if(!f.iframeTarget)h.remove();d.responseXML=null},100)}var s=o[0],u,a,f,l,c,h,p,d,v,m,g,y;var b=!!e.fn.prop;if(i){for(a=0;a<i.length;a++){u=e(s[i[a].name]);u[b?"prop":"attr"]("disabled",false)}}if(e(":input[name=submit],:input[id=submit]",s).length){alert('Error: Form elements must not have name or id of "submit".');return}f=e.extend(true,{},e.ajaxSettings,n);f.context=f.context||f;c="jqFormIO"+(new Date).getTime();if(f.iframeTarget){h=e(f.iframeTarget);m=h.attr("name");if(m==null)h.attr("name",c);else c=m}else{h=e('<iframe name="'+c+'" src="'+f.iframeSrc+'" />');h.css({position:"absolute",top:"-1000px",left:"-1000px"})}p=h[0];d={aborted:0,responseText:null,responseXML:null,status:0,statusText:"n/a",getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(n){var r=n==="timeout"?"timeout":"aborted";t("aborting upload... "+r);this.aborted=1;h.attr("src",f.iframeSrc);d.error=r;f.error&&f.error.call(f.context,d,r,n);l&&e.event.trigger("ajaxError",[d,f,r]);f.complete&&f.complete.call(f.context,d,r)}};l=f.global;if(l&&!(e.active++)){e.event.trigger("ajaxStart")}if(l){e.event.trigger("ajaxSend",[d,f])}if(f.beforeSend&&f.beforeSend.call(f.context,d,f)===false){if(f.global){e.active--}return}if(d.aborted){return}v=s.clk;if(v){m=v.name;if(m&&!v.disabled){f.extraData=f.extraData||{};f.extraData[m]=v.value;if(v.type=="image"){f.extraData[m+".x"]=s.clk_x;f.extraData[m+".y"]=s.clk_y}}}var w=1;var E=2;if(f.forceSync){x()}else{setTimeout(x,10)}var T,N,C=50,k;var A=e.parseXML||function(e,t){if(window.ActiveXObject){t=new ActiveXObject("Microsoft.XMLDOM");t.async="false";t.loadXML(e)}else{t=(new DOMParser).parseFromString(e,"text/xml")}return t&&t.documentElement&&t.documentElement.nodeName!="parsererror"?t:null};var O=e.parseJSON||function(e){return window["eval"]("("+e+")")};var M=function(t,n,r){var i=t.getResponseHeader("content-type")||"",s=n==="xml"||!n&&i.indexOf("xml")>=0,o=s?t.responseXML:t.responseText;if(s&&o.documentElement.nodeName==="parsererror"){e.error&&e.error("parsererror")}if(r&&r.dataFilter){o=r.dataFilter(o,n)}if(typeof o==="string"){if(n==="json"||!n&&i.indexOf("json")>=0){o=O(o)}else if(n==="script"||!n&&i.indexOf("javascript")>=0){e.globalEval(o)}}return o}}if(!this.length){t("ajaxSubmit: skipping submit process - no element selected");return this}var r,i,s,o=this;if(typeof n=="function"){n={success:n}}r=this.attr("method");i=this.attr("action");s=typeof i==="string"?e.trim(i):"";s=s||window.location.href||"";if(s){s=(s.match(/^([^#]+)/)||[])[1]}n=e.extend(true,{url:s,success:e.ajaxSettings.success,type:r||"GET",iframeSrc:/^https/i.test(window.location.href||"")?"javascript:false":"about:blank"},n);var u={};this.trigger("form-pre-serialize",[this,n,u]);if(u.veto){t("ajaxSubmit: submit vetoed via form-pre-serialize trigger");return this}if(n.beforeSerialize&&n.beforeSerialize(this,n)===false){t("ajaxSubmit: submit aborted via beforeSerialize callback");return this}var a,f,l=this.formToArray(n.semantic);if(n.data){n.extraData=n.data;for(a in n.data){if(e.isArray(n.data[a])){for(var c in n.data[a]){l.push({name:a,value:n.data[a][c]})}}else{f=n.data[a];f=e.isFunction(f)?f():f;l.push({name:a,value:f})}}}if(n.beforeSubmit&&n.beforeSubmit(l,this,n)===false){t("ajaxSubmit: submit aborted via beforeSubmit callback");return this}this.trigger("form-submit-validate",[l,this,n,u]);if(u.veto){t("ajaxSubmit: submit vetoed via form-submit-validate trigger");return this}var h=e.param(l);if(n.type.toUpperCase()=="GET"){n.url+=(n.url.indexOf("?")>=0?"&":"?")+h;n.data=null}else{n.data=h}var p=[];if(n.resetForm){p.push(function(){o.resetForm()})}if(n.clearForm){p.push(function(){o.clearForm()})}if(!n.dataType&&n.target){var d=n.success||function(){};p.push(function(t){var r=n.replaceTarget?"replaceWith":"html";e(n.target)[r](t).each(d,arguments)})}else if(n.success){p.push(n.success)}n.success=function(e,t,r){var i=n.context||n;for(var s=0,u=p.length;s<u;s++){p[s].apply(i,[e,t,r||o,o])}};var v=e("input:file",this).length>0;var m="multipart/form-data";var g=o.attr("enctype")==m||o.attr("encoding")==m;if(n.iframe!==false&&(v||n.iframe||g)){if(n.closeKeepAlive){e.get(n.closeKeepAlive,function(){b(l)})}else{b(l)}}else{if(e.browser.msie&&r=="get"){var y=o[0].getAttribute("method");if(typeof y==="string")n.type=y}e.ajax(n)}this.trigger("form-submit-notify",[this,n]);return this};e.fn.ajaxForm=function(n){if(this.length===0){var r={s:this.selector,c:this.context};if(!e.isReady&&r.s){t("DOM not ready, queuing ajaxForm");e(function(){e(r.s,r.c).ajaxForm(n)});return this}t("terminating; zero elements found by selector"+(e.isReady?"":" (DOM not ready)"));return this}return this.ajaxFormUnbind().bind("submit.form-plugin",function(t){if(!t.isDefaultPrevented()){t.preventDefault();e(this).ajaxSubmit(n)}}).bind("click.form-plugin",function(t){var n=t.target;var r=e(n);if(!r.is(":submit,input:image")){var i=r.closest(":submit");if(i.length==0){return}n=i[0]}var s=this;s.clk=n;if(n.type=="image"){if(t.offsetX!=undefined){s.clk_x=t.offsetX;s.clk_y=t.offsetY}else if(typeof e.fn.offset=="function"){var o=r.offset();s.clk_x=t.pageX-o.left;s.clk_y=t.pageY-o.top}else{s.clk_x=t.pageX-n.offsetLeft;s.clk_y=t.pageY-n.offsetTop}}setTimeout(function(){s.clk=s.clk_x=s.clk_y=null},100)})};e.fn.ajaxFormUnbind=function(){return this.unbind("submit.form-plugin click.form-plugin")};e.fn.formToArray=function(t){var n=[];if(this.length===0){return n}var r=this[0];var i=t?r.getElementsByTagName("*"):r.elements;if(!i){return n}var s,o,u,a,f,l,c;for(s=0,l=i.length;s<l;s++){f=i[s];u=f.name;if(!u){continue}if(t&&r.clk&&f.type=="image"){if(!f.disabled&&r.clk==f){n.push({name:u,value:e(f).val()});n.push({name:u+".x",value:r.clk_x},{name:u+".y",value:r.clk_y})}continue}a=e.fieldValue(f,true);if(a&&a.constructor==Array){for(o=0,c=a.length;o<c;o++){n.push({name:u,value:a[o]})}}else if(a!==null&&typeof a!="undefined"){n.push({name:u,value:a})}}if(!t&&r.clk){var h=e(r.clk),p=h[0];u=p.name;if(u&&!p.disabled&&p.type=="image"){n.push({name:u,value:h.val()});n.push({name:u+".x",value:r.clk_x},{name:u+".y",value:r.clk_y})}}return n};e.fn.formSerialize=function(t){return e.param(this.formToArray(t))};e.fn.fieldSerialize=function(t){var n=[];this.each(function(){var r=this.name;if(!r){return}var i=e.fieldValue(this,t);if(i&&i.constructor==Array){for(var s=0,o=i.length;s<o;s++){n.push({name:r,value:i[s]})}}else if(i!==null&&typeof i!="undefined"){n.push({name:this.name,value:i})}});return e.param(n)};e.fn.fieldValue=function(t){for(var n=[],r=0,i=this.length;r<i;r++){var s=this[r];var o=e.fieldValue(s,t);if(o===null||typeof o=="undefined"||o.constructor==Array&&!o.length){continue}o.constructor==Array?e.merge(n,o):n.push(o)}return n};e.fieldValue=function(t,n){var r=t.name,i=t.type,s=t.tagName.toLowerCase();if(n===undefined){n=true}if(n&&(!r||t.disabled||i=="reset"||i=="button"||(i=="checkbox"||i=="radio")&&!t.checked||(i=="submit"||i=="image")&&t.form&&t.form.clk!=t||s=="select"&&t.selectedIndex==-1)){return null}if(s=="select"){var o=t.selectedIndex;if(o<0){return null}var u=[],a=t.options;var f=i=="select-one";var l=f?o+1:a.length;for(var c=f?o:0;c<l;c++){var h=a[c];if(h.selected){var p=h.value;if(!p){p=h.attributes&&h.attributes["value"]&&!h.attributes["value"].specified?h.text:h.value}if(f){return p}u.push(p)}}return u}return e(t).val()};e.fn.clearForm=function(){return this.each(function(){e("input,select,textarea",this).clearFields()})};e.fn.clearFields=e.fn.clearInputs=function(){var e=/^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i;return this.each(function(){var t=this.type,n=this.tagName.toLowerCase();if(e.test(t)||n=="textarea"){this.value=""}else if(t=="checkbox"||t=="radio"){this.checked=false}else if(n=="select"){this.selectedIndex=-1}})};e.fn.resetForm=function(){return this.each(function(){if(typeof this.reset=="function"||typeof this.reset=="object"&&!this.reset.nodeType){this.reset()}})};e.fn.enable=function(e){if(e===undefined){e=true}return this.each(function(){this.disabled=!e})};e.fn.selected=function(t){if(t===undefined){t=true}return this.each(function(){var n=this.type;if(n=="checkbox"||n=="radio"){this.checked=t}else if(this.tagName.toLowerCase()=="option"){var r=e(this).parent("select");if(t&&r[0]&&r[0].type=="select-one"){r.find("option").selected(false)}this.selected=t}})};})(jQuery)

/** 
 *  Another TextArea Autogrow plugin (0.2) alpha's alpha
 *  by Nikolay Borisov aka KOSIASIK
 *  mne@figovo.com
 *
 *  http://figovo.com/
 *
 *  Example: 
 *  $('textarea').ata();
 *
 *  jQuery required. Download it at http://jquery.com/
 *
 */

(function(e){e.fn.ata=function(t){t=e.extend({timer:100},t);return this.each(function(n){var r=e(this),i=this;i.style.resize="none";i.style.overflow="hidden";var s=i.value;i.style.height="0px";i.value="W\nW\nW";var o=i.scrollHeight;i.value="W\nW\nW";var u=i.scrollHeight;var a=u-o;i.value=s;s=null;var f=$("<div></div>");r.after(f);var l=f.get(0);l.style.padding="0px";l.style.margin="0px";r.bind("focus",function(){i.startUpdating()}).bind("blur",function(){i.stopUpdating()});this.heightUpdate=function(){if(s!=i.value){s=i.value;i.style.height="0px";var e=i.scrollHeight+a;if(e<=25){e=14}i.style.height=e+"px";l.style.height="auto";l.style.height=l.offsetHeight+"px"}};this.startUpdating=function(){i.interval=window.setInterval(function(){i.heightUpdate()},t.timer)};this.stopUpdating=function(){clearInterval(i.interval)};e(function(){i.heightUpdate()})})}})(jQuery)

/**
 * jQuery PrettyDate
 */

(function(e){e.fn.prettyDate=function(t){function o(e){var t=e.split("T");if(t.length==2){var n=t[0].split("-");var r=t[1].split(":");if(n.length==3&&r.length==3){return new Date(n[0],n[1]-1,n[2],r[0],r[1],r[2])}}return null}function u(n,r){var i=(n.getTime()-r.getTime())/1e3;var s=(new Date(r.getFullYear(),r.getMonth(),0)).getDate();var o=e.fn.prettyDate.regional[t.locale];var u=null;if(i<60){u=o.lessthanoneminutesince}else if(i<60*2){u=o.oneminutesince}else if(i<60*60){u=o.minutessince.replace("%m",Math.floor(i/60))}else if(i<60*60*2){u=o.onehourago}else if(i<60*60*24){u=o.hoursago.replace("%h",Math.floor(i/(60*60)))}else if(i<60*60*2*24&&(n.getDate()-1==r.getDate()||n.getDate()==1&&r.getDate()==s)){u=o.yesterday.replace("%h",a(r.getHours())).replace("%m",a(r.getMinutes()))}else if(i<60*60*4*24){u=o.weekdays[r.getDay()].replace("%h",a(r.getHours())).replace("%m",a(r.getMinutes()))}if(u==null){u=o.months[r.getMonth()].replace("%d",r.getDate()).replace("%h",a(r.getHours())).replace("%m",a(r.getMinutes()))}return u}function a(e){if(e<10){return"0"+e}else{return e}}function f(){var s=new Date;s.setTime(i+s.getTime()-r);e(n).each(function(t,r){var i=e(n[t]);var a=i.attr("date-data");i.html(u(s,o(a)))});setTimeout(f,t.refreshInterval*1e3)}var n=this;if(typeof t=="undefined"){t={}}if(typeof t.refreshInterval=="undefined"){t.refreshInterval=60}if(typeof t.locale=="undefined"){t.locale="no"}var r=(new Date).getTime();var i=r;var s=o(t.serverTime);if(s!=null){i=s.getTime()}f();return this};e.fn.prettyDate.regional={}})(jQuery);(function(e){e.fn.prettyDate.regional.no={lessthanoneminutesince:"Mindre enn et minutt siden",oneminutesince:"1 minutt siden",minutessince:"%m minutter siden",onehourago:"1 time siden",hoursago:"%h timer siden",yesterday:"i går kl %h:%m",weekdays:["søndag kl %h:%m","mandag kl %h:%m","tirsdag kl %h:%m","onsdag kl %h:%m","torsdag kl %h:%m","fredag kl %h:%m","lørdag kl %h:%m"],months:["%d. januar kl %h:%m","%d. februar kl %h:%m","%d. mars kl %h:%m","%d. april kl %h:%m","%d. mai kl %h:%m","%d. juni kl %h:%m","%d. juli kl %h:%m","%d. august kl %h:%m","%d. september kl %h:%m","%d. oktober kl %h:%m","%d. november kl %h:%m","%d. desember kl %h:%m"]};e.fn.prettyDate.regional.en={lessthanoneminutesince:"Less than a minute ago",oneminutesince:"1 minute ago",minutessince:"%m minutes ago",onehourago:"1 hour ago",hoursago:"%h hours ago",yesterday:"Yesterday at %h:%m",weekdays:["Sunday at %h:%m","Monday at %h:%m","Tuesday at %h:%m","Wednesday at %h:%m","Thursday at %h:%m","Friday at %h:%m","Saturday at %h:%m"],months:["%d. January at %h:%m","%d. February at %h:%m","%d. March at %h:%m","%d. April at %h:%m","%d. May at %h:%m","%d. June at %h:%m","%d. July at %h:%m","%d. August at %h:%m","%d. September at %h:%m","%d. October at %h:%m","%d. November at %h:%m","%d. December at %h:%m"]}})(jQuery)


// Globale variabler som servertid osv
var serverTime = "<aksess:getdate format="yyyy-MM-dd'T'HH:mm:ss"/>";
var contextPath = "<aksess:geturl/>";
var locale = "<c:out value="${fn:substring(aksess_locale, 0, 2)}"/>";
var oa_forum_enableEnterAsCommentPostAction = true;


function setEnableEnterAsPostCommentAction(value){
    oa_forum_enableEnterAsCommentPostAction = value;
}

$(document).ready(function(){

    $("#oa-forum-newPost .oa-forum-sharefield").ata();

    var loadTime = new Date().getTime();
    var newThreadsTemplate = "<kantega:label key="forum.wall.newThreads" bundle="forum" locale="${forumLocale}"/>";
    // Handles loading and animation of the wall.
    loadWallThreads(true);
    $("#oa-forum-wall-load-more-threads a").on("click", function(event){
        event.preventDefault();
        loadWallThreads(true);
        $(this).parent().hide();
    });

    setTimeout(updateWithNumberOfNewPosts, 10000);

    function updateWithNumberOfNewPosts() {
        var newpostsContainer = $("#oa-forum-forumContent .oa-forum-new-posts");
        <aksess:getuser name="user" />
        $.get("<aksess:geturl url="/forum/numberOfNewThreads"/>" , {forumId:${forumId}, forumCategoryId: ${forumCategoryId}, timeStamp:loadTime, username:'${user.id}'}, function(data) {
                    if(data.numberOfNewThreads > 0){
                        var loadNewThreads = $('<a class="numberOfNewThreads" href="">'+newThreadsTemplate.replace('$$', data.numberOfNewThreads)+'</a>');
                        loadNewThreads.click(function(event){
                            event.preventDefault();
                            newpostsContainer.html('');
                            loadTime = new Date().getTime();
                            loadWallThreads(false);

                            return false;
                        });
                        newpostsContainer.html(loadNewThreads);
                    }
                }
        );
        setTimeout(updateWithNumberOfNewPosts, 10000);
    }

    function loadWallThreads(loadMore) {
        var $forumContent = $("#oa-forum-forumContent .oa-forum-threads");
        var noThreads = $(".oa-forum-thread", $forumContent).length;
        var forumWallUrl = "${forumListPostsUrl}";
        if (noThreads > 0 && loadMore) {
            forumWallUrl += "&offset=" + noThreads;
        }
        $.post(forumWallUrl, function(data){
            $("#oa-forum-loading-animation").fadeOut(150, function(){
                $forumContent = $("#oa-forum-forumContent .oa-forum-threads");
                var $processedData = $('<div></div>').html(data);
                $processedData.find(".oa-forum-sharefield").ata();
                if (loadMore) {
                    $forumContent.append($processedData.children());
                }else{
                    $forumContent.html($processedData.children());
                }
                $(".oa-forum-date", $forumContent).each(function(){
                    $(this).prettyDate({serverTime: serverTime, locale: locale});
                });
                if ($(".oa-forum-thread:last-child", $forumContent).hasClass("oa-forum-thread-has-more-posts")) {
                    $("#oa-forum-wall-load-more-threads").show();
                }
                $("body").trigger('oa.forumwall.loaded');
            });
        });
    }

    // Handles posting of status
    $('#oa-forum-sharebox .oa-forum-ajaxForm').ajaxForm({
        beforeSerialize: function($form, options){
            $form.find("textarea").val(replaceURLWithHTMLLinks($form.find("textarea").val()));
        },
        beforeSubmit: function(arr, $form, options) {
            if ($.trim($form.find("textarea").val()).length < 1 ) {
                alert('<kantega:label key="forum.wall.status.missing" bundle="forum" locale="${forumLocale}"/>');
                return false;
            }
            if($.trim($form.find("label").text()) == $.trim($form.find("textarea").val())) {
                alert('<kantega:label key="forum.wall.status.missing" bundle="forum" locale="${forumLocale}"/>');
                return false;
            }

            var containerHeight = $form.parent().height();
            $form.parent().css("height", containerHeight);
            $form.fadeOut(300, function(){
                $("#submit-animation span").clone(false).css("line-height", containerHeight  + "px").css("text-align", "center").hide().appendTo($form.parent()).fadeIn(300);
            });
            return true;
        },
        resetForm: true,
        success: prependNewThread
    });

    $('#oa-forum-sharebox-textarea').on('focus', function() {
        $('#oa-forum-sharebox-buttons').show();
        $('#oa-forum-sharebox-buttons').removeClass('oa-forum-hidden');
    });

    $('#oa-forum-share-add-attachment a').on('click', function(event) {
        event.preventDefault();
        $("#oa-forum-share-add-attachment").hide();
        $("#oa-forum-share-attachment").show();
    });

    function replaceURLWithHTMLLinks(text) {
        var replacedText, replacePattern1, replacePattern2, replacePattern3;

        //URLs starting with http://, https://, or ftp://
        replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
        replacedText = text.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

        //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
        replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
        replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

        //Change email addresses to mailto:: links.
        replacePattern3 = /([_A-Za-z0-9-]+(\.[_A-Za-z0-9-]+)*@([a-zA-Z_]+?\.)+[a-zA-Z]{2,6})/gim;
        replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

        return replacedText;
    }



    // Appends new "shares" to top of wall.
    function prependNewThread(responseText, statusText, xhr, $form)  {
        // Hide animation, show form
        $form
        window.setTimeout(function(){     // Timeout to allow the animation to complete
            $form.parent().find(".oa-forum-submit-animation").fadeOut(300, function(){
                $form.find("#oa-forum-sharebox-buttons").hide();
                $form.fadeIn(300);
                var $newThread = $(responseText);
                $newThread.find(".oa-forum-date").prettyDate({serverTime: serverTime, locale: locale});
                $newThread.hide().prependTo(".oa-forum-threads").slideDown();
                $(this).remove();
                $form.find("textarea").addClass("oa-forum-fadedText");
            });
        }, 1200);
    }

    // Appends new "shares" to top of wall.
    function prependNewThreadForLink(responseText, statusText, xhr, $form)  {
        // Hide animation, show form
        $("#oa-forum-link-shareUrl").addClass("oa-forum-fadedText");
        $("#oa-forum-link-shareComment").addClass("oa-forum-fadedText");
        window.setTimeout(function(){     // Timeout to allow the animation to complete
            $form.closest(".oa-forum-tab-container").find(".oa-forum-submit-animation").fadeOut(250, function(){
                $("#oa-forum-linkform").fadeIn(250);
                var $newThread = $(responseText);
                $newThread.find(".oa-forum-date").prettyDate({serverTime: serverTime, locale: locale});
                $newThread.hide().prependTo(".oa-forum-threads").slideDown();
                $(this).remove();
            });
        }, 800);
    }

    function postComment(element){
        var $commentTextarea = $(element);
        var $commentForm = $commentTextarea.closest("form");
        var commentFormAction = $commentForm.attr("action");
        var comment = $.trim($commentTextarea.val());
        comment = replaceURLWithHTMLLinks(comment);
        $commentTextarea.val("");
        if (comment.length > 0){
            var threadId = $("input[name=threadId]", $commentForm).val();
            var formParams = { threadId:  threadId, body: comment, subject: "subject" };

            // Animating posting process
            var containerHeight = $commentForm.parent().height();
            $commentForm.fadeOut(150, function(){
                $("#submit-animation span").clone(false).css("line-height", containerHeight  + "px").css("text-align", "center").hide().appendTo($commentForm.parent()).fadeIn(150);
            });

            $.post(commentFormAction, formParams, function(data) {
                window.setTimeout(function(){
                    var $newPost = $(data);
                    $newPost.find(".oa-forum-date").prettyDate({serverTime: serverTime, locale: locale});
                    $newPost.hide();
                    $newPost.appendTo($commentTextarea.closest(".oa-forum-thread").find(".oa-forum-posts"));
                    var $animation = $commentForm.parent().find(".oa-forum-submit-animation");
                    $animation.fadeOut(150, function(){
                        $commentForm.fadeIn(150);
                        $newPost.slideDown();
                        $animation.remove();
                    })
                }, 800);
            });
        }
    }


    // Handles shifting between the "share tabs" (status, photo and link)
    var $tablinks = $("#oa-forum-newPost .oa-forum-tablink");
    var visibleTabIndex = -1;
    var $tabs = $("#oa-forum-newPost .oa-forum-tab-container");
    $("#oa-forum-newPost .oa-forum-tablink").click(function(e){
        e.preventDefault();
        var index = $(this).parent().prevAll().length -1; // -1 because the first element is the <li> containing "Share:"
        if (visibleTabIndex == index){
            // Do nothing, its already displaying
        } else if (visibleTabIndex == -1) {
            // Ingen synlige, vis den vi klikket på
            $tabs.eq(index).hide().removeClass("oa-forum-hidden").slideDown("normal", function(){
                visibleTabIndex = index;
                $(this).addClass("oa-forum-visible-tablink");
            });
        } else {
            $("#oa-forum-newPost .oa-forum-visible-tablink").slideUp("normal", function(){
                $(this).removeClass("oa-forum-visible-tablink");
                $tabs.eq(index).hide().removeClass("oa-forum-hidden").slideDown("normal", function(){
                    visibleTabIndex = index;
                    $(this).addClass("oa-forum-visible-tablink");
                });
            });
        }
        $tablinks.removeClass("oa-forum-selected-sharelink");
        $(this).addClass("oa-forum-selected-sharelink");
        return false;
    });

    // Handles input field label, hiding and removing these on/out-of focus.
    $(".oa-forum-sharefield").on("focusin", function(){
        var $field = $(this);
        var fieldVal = $.trim($field.val());
        var fieldLabel = $field.siblings("label").text();
        if (fieldVal == fieldLabel) {
            $field.val("");
            $field.removeClass("oa-forum-fadedText");
        }
    });
    $(".oa-forum-sharefield").on("focusout", function(){
        var $field = $(this);
        var fieldVal = $.trim($field.val());
        var fieldLabel = $field.siblings("label").text();
        if (fieldVal == "") {
            $field.val(fieldLabel);
            $field.addClass("oa-forum-fadedText");
        }
    });

    // link listener to display hidden ratings in a thread.
    $(".oa-forum-showAllRatings").on("click", function(event){
        event.preventDefault();
        $(this).hide();
        $(this).siblings(".oa-forum-minimizedRatings").show();
    });

    // link listener to display hidden comments in a thread.
    $(".oa-forum-showFullThread").on("click", function(event){
        event.preventDefault();
        $(this).hide();
        $(this).closest(".oa-forum-posts").find(".oa-forum-post").removeClass("oa-forum-hidden");
        $(this).siblings(".oa-forum-minimizeThread").show();
        $(this).siblings(".oa-forum-minimizeThread").removeClass("oa-forum-hidden");
    });

    // link listener to hide previous shown comments in a thread.
    $(".oa-forum-minimizeThread").on("click", function(event){
        event.preventDefault();
        $(this).hide();
        $(this).siblings(".oa-forum-showFullThread").show();
        $(this).closest(".oa-forum-posts").find(".oa-forum-post").addClass("oa-forum-hidden");
        $(this).closest(".oa-forum-posts").find(".oa-forum-post:last-child, .oa-forum-post:first-child").removeClass("oa-forum-hidden");
    });

    // Handles showing comment form on a thread
    $(".oa-forum-showReplyForm").on("click", function(event){
        event.preventDefault();
        var $commentarea = $(this).closest(".oa-forum-thread").find(".oa-forum-reply").removeClass("oa-forum-hidden").find("textarea");
        window.setTimeout(function(){
            $commentarea.focus();
            var $field = $commentarea;
            var fieldVal = $.trim($field.val());
            var fieldLabel = $field.siblings("label").text();
            if (fieldVal == fieldLabel) {
                $field.val("");
                $field.removeClass("oa-forum-fadedText");
            }
        },10);
    });

    $(".oa-forum-post-preview-show-full-body-link").on("click", function(event){
        event.preventDefault();
        var $link = $(this);
        var $postBody = $link.closest(".oa-forum-body");
        $postBody.find(".oa-forum-post-preview-more-indicator").hide();
        $link.prev("br").hide();
        $link.next("br").hide();
        $postBody.find(".oa-forum-post-preview-hidden-post-body").show();
        $link.hide();
    });

    // Handles posting comments and updating gui on a thread
    var enterKeyCode = 13;
    $(".oa-forum-thread .oa-forum-comment-reply").on("keyup", function(event){
        if (event.keyCode == enterKeyCode && oa_forum_enableEnterAsCommentPostAction) {
            event.preventDefault();
            if(this.value != this.defaultValue){
                postComment(this);
            }
        }
    });

    $(".oa-forum-share-comment").on("click", function(event){
        event.preventDefault();
        var commentText = $(this).closest("div").siblings("div").children("textarea")[0];
        if(commentText.value != commentText.defaultValue){
            postComment($(this).closest("div").siblings("div").children("textarea"));
        }
    });

    // Handles deleting posts
    $(".oa-forum-deletePost").on("click", function(event){
        event.preventDefault();
        var confirmDelete = confirm('<kantega:label key="forum.wall.confirmdeletepost" bundle="forum" locale="${forumLocale}"/>');
        if (confirmDelete) {
            var deleteUrl = $(this).attr("href");
            var $post = $(this).closest(".oa-forum-post");
            $.post(deleteUrl, function(data, textStatus, jqXHR){
                if (data["deleted"]) {
                    $post.slideUp("normal", function(){

                    });
                }
            }, "json");
        }
    });

    // Handles deleting threads
    $(".oa-forum-deleteThread").on("click", function(event){
        event.preventDefault();
        var confirmDelete = confirm('<kantega:label key="forum.wall.confirmdeletethread" bundle="forum" locale="${forumLocale}"/>');
        if (confirmDelete) {
            var deleteUrl = $(this).attr("href");
            var $thread = $(this).closest(".oa-forum-thread");
            $.post(deleteUrl, function(data, textStatus, jqXHR){
                if (data["deleted"]) {
                    $thread.slideUp("normal", function(){

                    });
                }
            }, "json");
        }
    });

    $(".oa-forum-like-link").on("click", function(event){
        event.preventDefault();
        $(this).closest(".oa-forum-post").find(".oa-forum-likeForm").submit();
        /*
         Ferdig? Bør oppdatere teksten på lenka.
         */
        $(this).next().before('<span class="oa-forum-has-liked"><kantega:label key="forum.wall.likes" bundle="forum" locale="${forumLocale}"/></span>');
        $(this).remove();
    });

    // attach handler to form's submit event
    $('.oa-forum-likeForm').on("submit", function() {
        $(this).ajaxSubmit({success: updateLikeStatusOfPost});
        return false;
    });

    function updateLikeStatusOfPost(responseText, statusText, xhr, $form) {
        var url = $form.attr("action") + "?objectId=" + $form.find("input[name='objectId']").val() + "&context=" + $form.find("input[name=context]").val();
        $.getJSON(url, function(data) {
            if ($form.closest(".oa-forum-post").find(".oa-forum-likes").length) {
                $form.closest(".oa-forum-post").find(".oa-forum-likes");
            }
        });
    }


    // Handles viewing larger versions of images
    $(".oa-forum-attachment, .oa-forum-enlarge-photo").on("click", function(event){
        var $attachmentContainer = $(this).closest(".oa-forum-attachments");
        var $imgLink = $attachmentContainer.find(".oa-forum-attachment");
        if ($imgLink.find("img").length){
            event.preventDefault();
            $imgLink.removeClass("oa-forum-attachment").addClass("oa-forum-attachment-image-fullsize");
            var $img = $imgLink.find("img");

            // Setting the img width before changing the img "src" attripute
            var origImgWidth = $img.width();
            var origImgHeight = $img.height();
            $img.data("origImgWidth", origImgWidth);
            $img.data("origImgHeight", origImgHeight);
            $img.css("width", origImgWidth + "px");
            $img.css("height", origImgHeight + "px");

            // Finding and setting the max width and height for the large version of the image
            var maxImgWidth = $attachmentContainer.width(); // Extra padding
            var multiplyHeightBy = Math.round(maxImgWidth / origImgWidth );
            var maxImgHeight = Math.round(origImgHeight * multiplyHeightBy);

            // Replacing the img url with the new img width and height.
            var newImgSrc = $img.attr("src").substring(0, $img.attr("src").indexOf("width="));
            newImgSrc += "width=" + maxImgWidth + "&amp;height=" + maxImgHeight;

            $img.attr("src", newImgSrc);
            $img.animate({
                width: maxImgWidth,
                height: maxImgHeight
            }, 400, function() {
                $attachmentContainer.find(".oa-forum-enlarge-photo").addClass("oa-forum-hidden");
                $attachmentContainer.find(".oa-forum-reduce-photo").removeClass("oa-forum-hidden");
                $attachmentContainer.find(".oa-forum-download-original").removeClass("oa-forum-hidden");
            });
        }
    });

    $(".oa-forum-attachment-image-fullsize, .oa-forum-reduce-photo").on("click", function(event){
        event.preventDefault();
        var $attachmentContainer = $(this).closest(".oa-forum-attachments");
        var $imgLink = $attachmentContainer.find(".oa-forum-attachment-image-fullsize");
        $imgLink.removeClass("oa-forum-attachment-image-fullsize").addClass("oa-forum-attachment");
        var $img = $imgLink.find("img");

        $img.animate({
            width: $img.data("origImgWidth"),
            height: $img.data("origImgHeight")
        }, 400, function() {
            var $attachmentContainer = $(this).closest(".oa-forum-attachments");
            $attachmentContainer.find(".oa-forum-enlarge-photo").removeClass("oa-forum-hidden");
            $attachmentContainer.find(".oa-forum-reduce-photo").addClass("oa-forum-hidden");
            $attachmentContainer.find(".oa-forum-download-original").addClass("oa-forum-hidden");
        });
    });
});