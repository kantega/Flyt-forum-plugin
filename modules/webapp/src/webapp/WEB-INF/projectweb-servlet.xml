<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!--
  - Application context definition for "springapp" DispatcherServlet.
  -->

<beans>

  <bean id="urlMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
    <property name="interceptors">
      <list>
        <bean class="no.kantega.projectweb.interceptors.UserResolvedInterceptor">
          <property name="userResolver">
            <ref bean="userResolver"/>
          </property>
        </bean>
        <bean class="no.kantega.projectweb.interceptors.MenuSelectionInterceptor">
          <property name="selected">
            <value>project</value>
          </property>
        </bean>
      </list>
    </property>
    <property name="urlMap">
      <map>
        <entry key="/">
          <ref bean="projectListController"/>
        </entry>
        <entry key="/projectlist">
          <ref bean="projectListController"/>
        </entry>
        <entry key="/addproject">
          <bean class="no.kantega.projectweb.control.project.AddProjectController" parent="daoAware">
            <property name="formView">
              <value>editproject</value>
            </property>
            <property name="commandName">
              <value>project</value>
            </property>
            <property name="commandClass">
              <value>no.kantega.projectweb.model.Project</value>
            </property>
            <property name="validator">
              <bean class="no.kantega.projectweb.control.validator.ProjectValidator"/>
            </property>
          </bean>
        </entry>
        <entry key="/project">
          <bean class="no.kantega.projectweb.control.project.ProjectController" parent="daoAware">
            <property name="userProfileManager">
              <ref bean="userProfileManager"/>
            </property>
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
            <property name="permissionManager">
              <ref bean="permissionManager"/>
            </property>

          </bean>

        </entry>
        <entry key="/editproject">
          <bean class="no.kantega.projectweb.control.project.EditProjectController" parent="daoAware">
            <property name="formView">
              <value>editproject</value>
            </property>
            <property name="commandName">
              <value>project</value>
            </property>
            <property name="commandClass">
              <value>no.kantega.projectweb.model.Project</value>
            </property>
            <property name="validator">
              <bean class="no.kantega.projectweb.control.validator.ProjectValidator"/>
            </property>
            <property name="userProfileManager">
              <ref bean="userProfileManager"/>
            </property>
          </bean>
        </entry>
      </map>
    </property>
  </bean>
  <bean id="urlMapping2" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
    <property name="interceptors">
      <list>
        <bean class="no.kantega.projectweb.interceptors.UserResolvedInterceptor">
          <property name="userResolver">
            <ref bean="userResolver"/>
          </property>
        </bean>
        <bean class="no.kantega.projectweb.interceptors.MenuSelectionInterceptor">
          <property name="selected">
            <value>participants</value>
          </property>
        </bean>
      </list>
    </property>
    <property name="urlMap">
      <map>

        <entry key="/participantlist">
          <bean class="no.kantega.projectweb.control.participant.ParticipantListController" parent="daoAware">
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
            <property name="permissionManager">
              <ref bean="permissionManager"/>
            </property>
            <property name="userProfileManager">
              <ref bean="userProfileManager"/>
            </property>

          </bean>
        </entry>
        <entry key="/editparticipantroles">
          <bean class="no.kantega.projectweb.control.participant.EditRolesController" parent="daoAware">
            <property name="userProfileManager">
              <ref bean="userProfileManager"/>
            </property>
            <property name="roleManager">
              <ref bean="roleManager"/>
            </property>
          </bean>
        </entry>
        <entry key="/addparticipant">
          <bean class="no.kantega.projectweb.control.participant.AddParticipantController" parent="daoAware">
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
            <property name="permissionManager">
              <ref bean="permissionManager"/>
            </property>
            <property name="userSearcher">
              <ref bean="userSearcher"/>
            </property>
            <property name="defaultRoles">
              <value>prosjektdeltaker</value>
            </property>
          </bean>
        </entry>
        <entry key="/removeparticipant">
          <bean class="no.kantega.projectweb.control.participant.RemoveParticipantController" parent="daoAware">
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
            <property name="permissionManager">
              <ref bean="permissionManager"/>
            </property>
          </bean>
        </entry>

      </map>
    </property>
  </bean>
  <bean id="urlMapping3" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
    <property name="interceptors">
      <list>
        <bean class="no.kantega.projectweb.interceptors.UserResolvedInterceptor">
          <property name="userResolver">
            <ref bean="userResolver"/>
          </property>
        </bean>
        <bean class="no.kantega.projectweb.interceptors.MenuSelectionInterceptor">
          <property name="selected">
            <value>activities</value>
          </property>
        </bean>
      </list>
    </property>
    <property name="urlMap">
      <map>

        <entry key="/activitylist">
          <bean class="no.kantega.projectweb.control.activity.ActivityListController" parent="daoAware">
            <property name="userProfileManager">
              <ref bean="userProfileManager"/>
            </property>
            <property name="statusManager">
              <ref bean="activityStatusManager"/>
            </property>
          </bean>
        </entry>
        <entry key="/addactivity">
          <bean class="no.kantega.projectweb.control.activity.AddActivityController" parent="workflowController">
            <property name="formView">
              <value>editactivity</value>
            </property>
            <property name="commandName">
              <value>activity</value>
            </property>
            <property name="commandClass">
              <value>no.kantega.projectweb.model.Activity</value>
            </property>
            <property name="validator">
              <bean class="no.kantega.projectweb.control.validator.ActivityValidator"/>
            </property>
            <property name="userProfileManager">
              <ref bean="userProfileManager"/>
            </property>
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>

          </bean>
        </entry>
        <entry key="/activity">
          <bean class="no.kantega.projectweb.control.activity.ActivityController" parent="workflowController">
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
          </bean>
        </entry>
        <entry key="/editactivity">
          <bean class="no.kantega.projectweb.control.activity.EditActivityController" parent="activityController">
            <property name="formView">
              <value>editactivitysummary</value>
            </property>
          </bean>
        </entry>
        <entry key="/editactivitysummary">
          <bean class="no.kantega.projectweb.control.activity.EditActivityController" parent="activityController">
            <property name="formView">
              <value>editactivitysummary</value>
            </property>
          </bean>
        </entry>
        <entry key="/editactivityeconomy">
          <bean class="no.kantega.projectweb.control.activity.EditActivityController" parent="activityController">
            <property name="formView">
              <value>editactivityeconomy</value>
            </property>
          </bean>
        </entry>
        <entry key="/addactivitycomment">
          <bean class="no.kantega.projectweb.control.activity.AddCommentController" parent="daoAware">
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
          </bean>
        </entry>


        <!--<entry key="/documentlist">
          <bean class="no.kantega.projectweb.control.document.DocumentListController" parent="daoAware"/>
        </entry>
        <entry key="/addocument">
          <bean class="no.kantega.projectweb.control.document.AddDocumentController" parent="workflowController">
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
          </bean>
        </entry>
        <entry key="/document">
          <bean class="no.kantega.projectweb.control.document.DocumentController" parent="workflowController">
            <property name="userResolver">
              <ref bean="userResolver"/>
            </property>
          </bean>
        </entry>-->
<!--
        <entry key="/adduser">
          <bean class="no.kantega.projectweb.control.user.AddUserController">
            <property name="userManager">
              <ref bean="userManager"/>
            </property>
          </bean>
        </entry>

        <entry key="/userlist">
          <bean class="no.kantega.projectweb.control.user.AddUserController">
            <property name="userManager">
              <ref bean="userManager"/>
            </property>
          </bean>
        </entry>
    -->
        <entry key="/activityworkflow">
          <bean class="no.kantega.projectweb.control.workflow.ActivityWorkflowController" parent="workflowController"/>
        </entry>
        <!--<entry key="/documentworkflow">
          <bean class="no.kantega.projectweb.control.workflow.DocumentWorkflowController" parent="workflowController"/>
        </entry>-->

      </map>
    </property>
  </bean>
  <bean id="urlMapping4" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping">
    <property name="interceptors">
      <list>
        <bean class="no.kantega.projectweb.interceptors.UserResolvedInterceptor">
          <property name="userResolver">
            <ref bean="userResolver"/>
          </property>
        </bean>
        <bean class="no.kantega.projectweb.interceptors.GlobalPermissionInterceptor">
          <property name="permission">
            <value>1</value>
          </property>
          <property name="userResolver">
            <ref bean="userResolver"/>
          </property>
          <property name="permissionManager">
            <ref bean="permissionManager"/>
          </property>
        </bean>
        <bean class="no.kantega.projectweb.interceptors.MenuSelectionInterceptor">
          <property name="selected">
            <value>admin</value>
          </property>
        </bean>
      </list>
    </property>
    <property name="urlMap">
      <map>

        <entry key="/admin">
          <bean class="no.kantega.projectweb.admin.AdminController"/>
        </entry>
        <entry key="/administratorlist">
          <bean class="no.kantega.projectweb.admin.AdministratorListController" parent="daoAware">
            <property name="administratorGroup">
              <value>administrators</value>
            </property>
          </bean>
        </entry>
        <entry key="/addadministrator">
          <bean class="no.kantega.projectweb.admin.AddAdministratorController" parent="daoAware">
            <property name="administratorGroup">
              <value>administrators</value>
            </property>
            <property name="userSearcher">
              <ref bean="userSearcher"/>
            </property>
          </bean>
        </entry>
        <entry key="/removeadministrator">
          <bean class="no.kantega.projectweb.admin.RemoveAdministratorController" parent="daoAware">
            <property name="administratorGroup">
              <value>administrators</value>
            </property>
          </bean>
        </entry>

      </map>

    </property>
  </bean>

  <bean id="daoAware" abstract="true">
    <property name="dao">
      <ref local="dao"/>
    </property>
  </bean>
  <bean id="workflowController" abstract="true" parent="daoAware">
      <property name="workflowFactory">
        <ref local="basicWorkflowFactory"/>
      </property>
    <property name="userResolver">
      <ref bean="userResolver"/>
    </property>
    </bean>

  <bean id="permissionCacheInvalidator" class="no.kantega.projectweb.permission.PermissionInvalidator">
    <property name="listeners">
      <list>
        <ref bean="permissionManager"/>
      </list>
    </property>

  </bean>
  <bean id="permissionManager" class="no.kantega.projectweb.permission.CachedPermissionManager">
    <property name="realPermissionManager">
      <bean class="no.kantega.projectweb.permission.SchemePermissionManager" >
          <property name="permissionSchemeManager">
            <bean class="no.kantega.projectweb.permission.scheme.PermissionSchemeManager" parent="daoAware">
              <property name="administratorRoles">
                <value>administrators</value>
              </property>
            </bean>
          </property>
        </bean>
    </property>
    <property name="refreshPeriod">
      <value>60</value>
    </property>
  </bean>

  <bean id="activityController" abstract="true" parent="daoAware">
    <property name="commandName"><value>activity</value></property>
    <property name="commandClass"><value>no.kantega.projectweb.model.Activity</value></property>
    <property name="validator">
      <bean class="no.kantega.projectweb.control.validator.ActivityValidator"/>
    </property>
    <property name="userProfileManager">
      <ref bean="userProfileManager"/>
    </property>
  </bean>


  <bean id="roleManager" class="no.kantega.projectweb.role.SimpleRoleManager" parent="daoAware"/>

  <bean id="activityStatusManager" class="no.kantega.projectweb.activity.SimpleActivityStatusManager" parent="daoAware"/>

  <bean id="projectListController" class="no.kantega.projectweb.control.project.ProjectListController" parent="daoAware">
    <property name="userResolver">
      <ref bean="userResolver"/>
    </property>
    <property name="permissionManager">
      <ref bean="permissionManager"/>
    </property>
  </bean>

  <bean id="createActivityFunction" class="no.kantega.projectweb.workflow.functions.activity.CreateActivityFunction" parent="daoAware">
    <property name="statusManager">
      <ref bean="activityStatusManager"/>
    </property>
  </bean>

  <bean id="updateActivityStatusFunction" class="no.kantega.projectweb.workflow.functions.activity.UpdateActivityStatusFunction" parent="daoAware"/>

  <bean id="createDocumentFunction" class="no.kantega.projectweb.workflow.functions.document.CreateDocumentFunction" parent="daoAware"/>

  <bean id="updateDocumentStatusFunction" class="no.kantega.projectweb.workflow.functions.document.UpdateDocumentStatusFunction" parent="daoAware"/>



  <bean id="sessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean" destroy-method="close">
      <property name="dataSource">
        <ref bean="projectwebDataSource"/>
      </property>
      <property name="mappingResources">
        <value>projectweb.hbm.xml</value>
      </property>
      <property name="hibernateProperties">
        <props>
          <prop key="hibernate.dialect">${projectweb.dialect.hibernate3}</prop>
          <prop key="hibernate.show_sql">true</prop>
        </props>
      </property>
      <property name="schemaUpdate">
        <value>true</value>
      </property>
    </bean>

  <bean id="sessionFactory2" class="org.springframework.orm.hibernate.LocalSessionFactoryBean" destroy-method="close">
        <property name="dataSource">
          <ref bean="projectwebDataSource"/>
        </property>
        <property name="mappingResources">
          <list>
            <value>com/opensymphony/workflow/spi/hibernate/HibernateWorkflowEntry.hbm.xml</value>
            <value>com/opensymphony/workflow/spi/hibernate/HibernateHistoryStep.hbm.xml</value>
            <value>com/opensymphony/workflow/spi/hibernate/HibernateCurrentStep.hbm.xml</value>
            <value>com/opensymphony/module/propertyset/hibernate/PropertySetItemImpl.hbm.xml</value>
          </list>
        </property>
        <property name="hibernateProperties">
          <props>
            <prop key="hibernate.dialect">${projectweb.dialect.hibernate2}</prop>
          </props>
        </property>
        <property name="schemaUpdate">
          <value>true</value>
        </property>
      </bean>


    <bean id="hibernateTemplate" class="org.springframework.orm.hibernate3.HibernateTemplate">
      <property name="sessionFactory">
        <ref local="sessionFactory"/>
      </property>
    </bean>

    <bean id="dao" class="no.kantega.projectweb.dao.ProjectWebDao">
      <property name="template">
        <ref local="hibernateTemplate"/>
      </property>
      <property name="permissionInvalidator">
        <ref bean="permissionCacheInvalidator"/>
      </property>
    </bean>

  <bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
          <property name="viewClass"><value>org.springframework.web.servlet.view.JstlView</value></property>
          <property name="prefix"><value>/WEB-INF/jsp/projectweb/</value></property>
          <property name="suffix"><value>.jsp</value></property>
      </bean>

  
  <bean id="workflowStore"
    class="com.opensymphony.workflow.spi.hibernate.SpringHibernateWorkflowStore">
      <property name="sessionFactory"><ref bean="sessionFactory2"/></property>
    <!--
    Optional PropertySet delegate, in case you want
    to use another PropertySet store that is not HibernateStore
    <property name="propertySetDelegate">
    <ref local="propertySetDelegate"/>
    </property>
        -->
  </bean>

  <bean id="workflowFactory"
    class="com.opensymphony.workflow.loader.SpringWorkflowFactory"
    init-method="init">
    <property name="resource"><value>workflows.xml</value></property>
    <property name="reload"><value>true</value></property>
  </bean>

  <bean id="osworkflowConfiguration"
        class="com.opensymphony.workflow.config.SpringConfiguration">
    <property name="store"><ref local="workflowStore"/></property>
        <property name="factory"><ref local="workflowFactory"/></property>
  </bean>

  <bean id="workflowTypeResolver"
        class="com.opensymphony.workflow.util.SpringTypeResolver"/>
 
  <bean id="basicWorkflowFactory"
        class="no.kantega.osworkflow.BasicWorkflowFactory">
    <property name="configuration">
      <ref local="osworkflowConfiguration"/>
    </property>
        <property name="typeResolver">
      <ref local="workflowTypeResolver"/>
    </property>
  </bean>

  <!--
  <bean id="userMangerConfigLoader" class="com.opensymphony.user.config.bean.BeanConfigLoader">
    <property name="authenticator">
      <bean class="com.opensymphony.user.config.bean.AuthenticatorConfig">
        <property name="classname">
          <value>com.opensymphony.user.authenticator.SmartAuthenticator</value>
        </property>
      </bean>
    </property>
    <property name="providers">
      <list>
        <bean class="com.opensymphony.user.config.bean.ProviderConfig">
          <property name="classname">
            <value>com.opensymphony.user.provider.memory.MemoryProfileProvider</value>
          </property>
        </bean>
        <bean class="com.opensymphony.user.config.bean.ProviderConfig">
          <property name="classname">
            <value>com.opensymphony.user.provider.memory.MemoryCredentialsProvider</value>
          </property>
        </bean>
        <bean class="com.opensymphony.user.config.bean.ProviderConfig">
          <property name="classname">
            <value>com.opensymphony.user.provider.memory.MemoryAccessProvider</value>
          </property>
        </bean>
      </list>
    </property>
  </bean>

  <bean id="userManager" class="com.opensymphony.user.UserManager">
    <constructor-arg index="0">
      <ref bean="userMangerConfigLoader"/>
    </constructor-arg>
  </bean>
   -->  
  <bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
    <property name="cacheSeconds">
      <value>5</value>
    </property>
    <property name="basenames">
      <list>
        <value>/WEB-INF/classes/projectweb</value>
        <value>/WEB-INF/classes/activitystatuses</value>
        <value>/WEB-INF/classes/validation</value>
      </list>
    </property>
  </bean>

  <bean id="localeResolver" class="org.springframework.web.servlet.i18n.FixedLocaleResolver">
    <property name="defaultLocale">
      <value>no</value>
    </property>
  </bean>

  <bean class="no.kantega.projectweb.conf.SpringPropertyReplacer">
    <property name="provider">
      <ref bean="springConfigProvider"/>
    </property>
  </bean>

</beans>